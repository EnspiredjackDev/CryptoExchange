# Crypto Exchange – Developer Documentation

*Last updated: 27 July 2025*
*Documentation created with the help of ChatGPT, otherwise it would look rubbish*

---

## 1  Introduction

### This document explains how to integrate with the HTTP REST API, describes the underlying data models, and outlines operational and security considerations for external or in‑house clients.
---

## 2  Base URL

```
https://api.example.com/
```

The current API is version **v1**. New, backwards‑compatible fields may be added without prior notice; breaking changes will trigger a new major version.

---

## 3  Authentication

1. **Create an account** and obtain an API key via `POST /create_account`.
2. Supply the key with every subsequent request in the `Authorization` header:

```http
Authorization: Bearer <your‑api‑key>
```

The key is a 64‑character hexadecimal string. Treat it like a password; it grants full access to the associated account.

---

## 4  HTTP Status Codes & Error Format

* **2xx** – success. Body contains the requested data.
* **4xx** – client error (missing field, invalid key, \&c.).
* **5xx** – server error. Retry or contact support if the condition persists.

Error bodies are JSON with an `error` field, e.g.

```json
{
  "error": "Invalid API key"
}
```

---

## 5  Endpoint Overview

| Path                | Method | Purpose                                                     | Auth required |
| ------------------- | ------ | ----------------------------------------------------------- | ------------- |
| `/create_account`   | POST   | Create a new user and return an API key                     | No            |
| `/generate_address` | POST   | Generate a deposit address for a coin                       | Yes           |
| `/addresses`        | GET    | List all generated addresses                                | Yes           |
| `/balance`          | GET    | Retrieve available, locked and total balances               | Yes           |
| `/withdraw`         | POST   | Withdraw on‑chain funds                                     | Yes           |
| `/order`            | POST   | Place a limit order                                         | Yes           |
| `/trades`           | GET    | Fetch personal trade history                                | Yes           |
| `/cancel_order`     | POST   | Cancel an open or partially‑filled order                    | Yes           |
| `/orderbook`        | GET    | Public order book snapshot                                  | No            |
| `/orders`           | GET    | List own open orders                                        | Yes           |
| `/markets`          | GET    | Public market summary                                       | No            |
| `/auth_test`        | GET    | Validate API key (debug)                                    | Yes           |
| `/admin/*`          | \*     | Administrative operations (requires server‑side protection) | \*            |

---

## 6  Detailed Endpoints

### 6.1  POST /create\_account

Creates a new user record and returns a freshly generated API key.

**Response 201**

```json
{
  "api_key": "6599c1…e8b2"
}
```

### 6.2  POST /generate\_address

Generate a unique deposit address for a supported coin.

**Headers**

```
Authorization: Bearer <api_key>
Content‑Type: application/json
```

**Body**

```json
{ "coin": "XMR" }
```

**Response 201**

```json
{
  "address": "87yAn…",
  "coin": "XMR"
}
```

*For Monero (`XMR`) a sub‑address is created; for Bitcoin‑like chains the Exchange queries the node until it obtains an unused address.*

### 6.3  GET /addresses

Query parameters:

* `coin` – optional; filter by coin symbol.

Returns a list of addresses previously generated by the authenticated user.

### 6.4  GET /balance

Query parameters:

* `coin` – optional; filter balances by coin.

Example response

```json
{
  "BTC": { "available": "0.05000000", "locked": "0.00000000", "total": "0.05000000" },
  "XMR": { "available": "12.34560000", "locked": "0.00000000", "total": "12.34560000" }
}
```

### 6.5  POST /withdraw

Withdraws cryptocurrency to an external address **after locking funds** to prevent double‑spend. Supported coins inherit the behaviour of their native nodes; fee deduction is handled by the node.

**Body**

```json
{
  "coin": "BTC",
  "to_address": "bc1q…",
  "amount": "0.01"
}
```

**Success 200**

```json
{
  "status": "success",
  "txid": "5f2c…",
  "amount": "0.01000000",
  "coin": "BTC"
}
```

### 6.6  POST /order

Creates a **limit order**. Market orders are not currently supported.

**Body**

```json
{
  "market_id": 1,
  "side": "buy",
  "price": "0.01250000",
  "amount": "200.0"
}
```

The response includes the generated order ID, fill summary, and any immediate trades.

### 6.7  POST /cancel\_order

Cancel an open or partially‑filled order. The remaining locked funds are immediately released back to the available balance.

### 6.8  GET /trades

Retrieve personal trade history. Optional query parameters:

* `market_id` – integer identifier from `/markets`.
* `coin` – filter by base or quote coin.
* `limit` – 1‑200, default 50.

### 6.9  GET /orderbook

Public, unauthenticated snapshot of the current order book for a market. Returns aggregated price levels up to the requested `depth` (1‑100).

### 6.10  GET /orders

List all **open** or **partially‑filled** orders belonging to the caller. Parameters `market_id` or `coin` may be supplied for filtering.

### 6.11  GET /markets

Returns statistics for every active market: last trade price, 24‑hour volume, best bid/ask, and percentage price change.

---

## 7  Data Precision & Rounding

* Quantities are stored as `DECIMAL(18, 8)` in the database.
* Incoming numbers are rounded **down** to 8 dp – the smallest tradable unit.
* Monero is converted to atomic units (`× 10¹²`) when interacting with the node.

---

## 8  Matching Engine

Orders are matched in‑process using `matcher.match_orders` within the same SQL transaction that places the order. The algorithm:

1. Locks the market via `pg_advisory_xact_lock` to ensure serialisation.
2. Iterates price‑time priority queues of buys and sells.
3. Applies a fixed taker/maker fee (default 0.1 %).
4. Updates balances and order status (`open` → `partially_filled` / `filled`).

Trades are inserted into the `trades` table along with fee records; fee income is moved into the exchange’s **fee balances**.

---

## 9  Environment Variables

| Variable                                | Description                                          |
| --------------------------------------- | ---------------------------------------------------- |
| `DATABASE_URL`                          | PostgreSQL connection string                         |
| `<COIN>_NODE_HOST`/`PORT`/`USER`/`PASS` | Node RPC credentials per coin – e.g. `BTC_NODE_HOST` |
| `<COIN>_NODE_TYPE`                      | `btc` *(default)* or `monero`                        |

---

## 10  Security Considerations

* All state‑changing requests **must** use HTTPS.
* API keys are hashed with SHA‑256 before storage.
* Each financial operation (`withdraw`, order placement) is executed inside an explicit or implicit **repeatable‑read** SQL transaction.
* Admin routes are currently unprotected; deploy behind a firewall or add proper authentication before production. // will be fixed

---

## 11  Sync Daemon

The standalone script `sync_balances.py` polls connected nodes, detects confirmed deposits, and credits user balances. It should run as a background job (e.g. systemd timer) every minute or two, subject to node performance.

---

## 12  Rate Limits & Best Practices

* The public endpoints (`/markets`, `/orderbook`) are cache‑friendly; please respect a 2 s minimum interval.
* Authenticated endpoints are limited to **60 requests per minute** per API key. Exceeding the limit returns HTTP 429.
* Batch calls where possible; e.g. fetch balances once before submitting multiple orders.
